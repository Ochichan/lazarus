name: Memory Benchmark

on:
  push:
    tags: ["v*"]
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: ðŸ“Š Memory Benchmark
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ“¦ Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: ðŸ”¨ Build release
        run: RUSTFLAGS="-C strip=symbols" cargo build --release

      - name: ðŸ“ Measure binary size
        id: binary
        run: |
          SIZE_BYTES=$(stat -c%s target/release/lazarus)
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1048576" | bc)
          SIZE_HUMAN=$(ls -lh target/release/lazarus | awk '{print $5}')

          echo "size_bytes=$SIZE_BYTES" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "size_human=$SIZE_HUMAN" >> $GITHUB_OUTPUT

          echo "## ðŸ“¦ Binary Size" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Size | **$SIZE_HUMAN** |" >> $GITHUB_STEP_SUMMARY
          echo "| Bytes | $SIZE_BYTES |" >> $GITHUB_STEP_SUMMARY

      - name: â±ï¸ Measure cold start
        id: coldstart
        run: |
          TOTAL=0
          for i in {1..5}; do
            START=$(date +%s%N)
            ./target/release/lazarus --help > /dev/null
            END=$(date +%s%N)
            ELAPSED=$(( (END - START) / 1000000 ))
            TOTAL=$((TOTAL + ELAPSED))
          done
          AVG=$((TOTAL / 5))

          echo "coldstart_ms=$AVG" >> $GITHUB_OUTPUT

          echo "## â±ï¸ Cold Start" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Average (5 runs) | **${AVG} ms** |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§  Measure memory (idle)
        id: memory
        run: |
          ./target/release/lazarus &
          PID=$!
          sleep 3

          PRIVATE_DIRTY=$(awk '/Private_Dirty/ {sum+=$2} END {printf "%.2f", sum/1024}' /proc/$PID/smaps)
          RSS=$(ps -p $PID -o rss= | awk '{printf "%.2f", $1/1024}')

          echo "private_dirty=$PRIVATE_DIRTY" >> $GITHUB_OUTPUT
          echo "rss=$RSS" >> $GITHUB_OUTPUT

          echo "## ðŸ§  Memory (Idle)" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Private_Dirty | **${PRIVATE_DIRTY} MB** |" >> $GITHUB_STEP_SUMMARY
          echo "| RSS | ${RSS} MB |" >> $GITHUB_STEP_SUMMARY

          kill $PID 2>/dev/null || true

      - name: ðŸ“Š Generate summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Binary Size | **${{ steps.binary.outputs.size_human }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Cold Start | **${{ steps.coldstart.outputs.coldstart_ms }} ms** |" >> $GITHUB_STEP_SUMMARY
          echo "| Idle RAM | **${{ steps.memory.outputs.private_dirty }} MB** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ZIM memory test verified locally: 115GB ZIM â†’ +1MB RAM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Measured on GitHub Actions Ubuntu runner*" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“ Create benchmark JSON
        run: |
          cat > benchmark.json << ENDJSON
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "${{ github.ref_name }}",
            "binary_size_mb": ${{ steps.binary.outputs.size_mb }},
            "coldstart_ms": ${{ steps.coldstart.outputs.coldstart_ms }},
            "memory_idle_mb": ${{ steps.memory.outputs.private_dirty }}
          }
          ENDJSON
          cat benchmark.json

      - name: ðŸ“¤ Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark.json
