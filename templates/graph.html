{% extends "base.html" %}
{% block title %}Graph View - Lazarus{% endblock %}
{% block content %}
<div class="graph-container">
    <header class="graph-header">
        <h1>ğŸ•¸ï¸ Knowledge Graph</h1>
        <div class="graph-controls">
            <button id="zoom-in" class="btn btn-sm">â•</button>
            <button id="zoom-out" class="btn btn-sm">â–</button>
            <button id="reset" class="btn btn-sm">ğŸ”„</button>
        </div>
    </header>
    <div id="graph"></div>
</div>

<style>
.graph-container {
    height: calc(100vh - 100px);
    display: flex;
    flex-direction: column;
}

.graph-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.graph-header h1 {
    margin: 0;
    font-size: 1.5rem;
}

.graph-controls {
    display: flex;
    gap: 0.5rem;
}

#graph {
    flex: 1;
    background: var(--bg-secondary);
    border-radius: 0.5rem;
    margin: 1rem;
    overflow: hidden;
}

.node {
    cursor: pointer;
}

.node circle {
    fill: var(--accent);
    stroke: #fff;
    stroke-width: 2px;
    transition: all 0.2s;
}

.node:hover circle {
    fill: #fff;
    stroke: var(--accent);
}

.node text {
    font-size: 12px;
    fill: var(--text);
    pointer-events: none;
}

/* ì™¸í†¨ì´ ë…¸ë“œ (ì—°ê²° ì—†ìŒ) */
.node.orphan circle {
    fill: #636e72;
    stroke: #e17055;
    stroke-dasharray: 4 2;
}

.node.orphan text {
    fill: #b2bec3;
}

.link {
    stroke: var(--border);
    stroke-opacity: 0.6;
    stroke-width: 1.5px;
}

.link:hover {
    stroke: var(--accent);
    stroke-opacity: 1;
}
</style>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
async function loadGraph() {
    const response = await fetch('/api/graph');
    const data = await response.json();
    
    if (data.nodes.length === 0) {
        document.getElementById('graph').innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: var(--text-secondary);">
                <p>ë…¸íŠ¸ë¥¼ ë§Œë“¤ê³  [[ë§í¬]]ë¡œ ì—°ê²°í•´ë³´ì„¸ìš”!</p>
            </div>
        `;
        return;
    }
    
    renderGraph(data);
}

function renderGraph(data) {
    const container = document.getElementById('graph');
    const width = container.clientWidth;
    const height = container.clientHeight;
    
    // ê¸°ì¡´ SVG ì œê±°
    d3.select('#graph svg').remove();

    const svg = d3.select('#graph')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
    
    const g = svg.append('g');

    // ì¤Œ ì„¤ì •
    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
        });
    
    svg.call(zoom);
    
    // ì¤Œ ì»¨íŠ¸ë¡¤
    document.getElementById('zoom-in').onclick = () => {
        svg.transition().call(zoom.scaleBy, 1.3);
    };
    document.getElementById('zoom-out').onclick = () => {
        svg.transition().call(zoom.scaleBy, 0.7);
    };
    document.getElementById('reset').onclick = () => {
        svg.transition().call(zoom.transform, d3.zoomIdentity);
    };

    // ë…¸ë“œë³„ ì—°ê²° ìˆ˜ ê³„ì‚° (ì™¸í†¨ì´ ê°ì§€ìš©)
    const connectionCount = {};
    data.nodes.forEach(n => connectionCount[n.id] = 0);
    data.edges.forEach(e => {
        const sourceId = e.source.id !== undefined ? e.source.id : e.source;
        const targetId = e.target.id !== undefined ? e.target.id : e.target;
        connectionCount[sourceId]++;
        connectionCount[targetId]++;
    });
    
    // Force simulation
    const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.edges)
            .id(d => d.id)
            .distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(50));
    
    // ë§í¬ ê·¸ë¦¬ê¸°
    const link = g.append('g')
        .selectAll('line')
        .data(data.edges)
        .enter()
        .append('line')
        .attr('class', 'link');
    
    // ë…¸ë“œ ê·¸ë¦¬ê¸° (ì™¸í†¨ì´ëŠ” ë‹¤ë¥¸ ìŠ¤íƒ€ì¼)
    const node = g.append('g')
        .selectAll('g')
        .data(data.nodes)
        .enter()
        .append('g')
        .attr('class', d => connectionCount[d.id] === 0 ? 'node orphan' : 'node')
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));
    
    // ë…¸ë“œ ì›
    node.append('circle')
        .attr('r', d => 10 + Math.sqrt(d.backlink_count) * 5);
    
    // ë…¸ë“œ ë¼ë²¨
    node.append('text')
        .attr('dx', 15)
        .attr('dy', 4)
        .text(d => d.title);
    
    // ë…¸ë“œ í´ë¦­ â†’ ë…¸íŠ¸ë¡œ ì´ë™
    node.on('click', (event, d) => {
        window.location.href = `/notes/${d.id}`;
    });
    
    // Simulation ì—…ë°ì´íŠ¸
    simulation.on('tick', () => {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
        
        node.attr('transform', d => `translate(${d.x},${d.y})`);
    });
    
    // ë“œë˜ê·¸ í•¨ìˆ˜
    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }
    
    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }
    
    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }
}

// ë¡œë“œ
loadGraph();

// ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
window.addEventListener('resize', loadGraph);
</script>
{% endblock %}
