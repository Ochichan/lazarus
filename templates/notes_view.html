{% extends "base.html" %}
{% block nav_notes %}{{ t["nav.notes"] }}{% endblock %}
{% block nav_search %}{{ t["nav.search"] }}{% endblock %}
{% block nav_wiki %}{{ t["nav.wiki"] }}{% endblock %}
{% block version %}{{ version }}{% endblock %}
{% block title %}{{ note.title }} - Lazarus{% endblock %}
{% block content %}
<div class="note-layout">
    <article class="note-view">
        <header class="note-header">
            <h1>{{ note.title }}</h1>
            <div class="note-meta">
                <time>{{ t["notes.created"] }}: {{ note.created_at }}</time>
                <time>{{ t["notes.updated"] }}: {{ note.updated_at }}</time>
            </div>
            {% if !note.tags.is_empty() %}
            <div class="note-tags">
                {% for tag in note.tags %}
                <span class="tag">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </header>
        <div class="note-content">
            {{ note.content|safe }}
        </div>
        
        <footer class="note-actions">
            <a href="/notes/{{ note.id }}/edit" class="btn">âœï¸ {{ t["notes.edit"] }}</a>
            <button class="btn btn-accent" id="extract-cards" data-note-id="{{ note.id }}">
                ğŸ§  {{ t["srs.create_cards"] }}
            </button>
            <button
                class="btn btn-danger"
                hx-delete="/api/notes/{{ note.id }}"
                hx-confirm="{{ t["notes.delete_confirm"] }}"
            >ğŸ—‘ï¸ {{ t["notes.delete"] }}</button>
        </footer>
    </article>
    
    <!-- ì—°ê²°ëœ ë…¸íŠ¸ ì‚¬ì´ë“œë°” -->
    <aside class="note-sidebar">
        {% if !outgoing_links.is_empty() %}
        <section class="link-section">
            <h3>ğŸ“¤ Links ({{ outgoing_links.len() }})</h3>
            <ul>
                {% for link in outgoing_links %}
                <li><a href="/notes/{{ link.id }}">{{ link.title }}</a></li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}
        
        {% if !backlinks.is_empty() %}
        <section class="link-section">
            <h3>ğŸ“¥ Backlinks ({{ backlinks.len() }})</h3>
            <ul>
                {% for link in backlinks %}
                <li><a href="/notes/{{ link.id }}">{{ link.title }}</a></li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}
        
        {% if outgoing_links.is_empty() && backlinks.is_empty() %}
        <section class="link-section empty">
            <p>ğŸ”— [[ë§í¬]]ë¡œ ë‹¤ë¥¸ ë…¸íŠ¸ì™€ ì—°ê²°í•´ë³´ì„¸ìš”!</p>
        </section>
        {% endif %}
        
        <a href="/graph" class="graph-link">ğŸ•¸ï¸ ê·¸ë˜í”„ì—ì„œ ë³´ê¸°</a>
    </aside>
</div>

<!-- ì–¸ì–´ ì„ íƒ -->
<section class="lang-selector">
    <form action="/api/lang" method="post" style="display: inline;">
        <button type="submit" name="lang" value="en" class="btn btn-sm {% if lang == "en" %}btn-primary{% else %}btn-secondary{% endif %}">EN</button>
        <button type="submit" name="lang" value="ko" class="btn btn-sm {% if lang == "ko" %}btn-primary{% else %}btn-secondary{% endif %}">í•œêµ­ì–´</button>
    </form>
</section>

<style>
.note-layout {
    display: grid;
    grid-template-columns: 1fr 250px;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.note-view {
    min-width: 0;
}

.note-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
}

.note-header h1 {
    margin-bottom: 0.5rem;
}

.note-meta {
    color: var(--text-secondary);
    font-size: 0.9rem;
    display: flex;
    gap: 1rem;
}

.note-tags {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.tag {
    background: var(--bg-secondary);
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
}

.note-content {
    line-height: 1.8;
    white-space: pre-wrap;
}

.note-actions {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* ì‚¬ì´ë“œë°” */
.note-sidebar {
    position: sticky;
    top: 1rem;
    height: fit-content;
}

.link-section {
    background: var(--bg-secondary);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.link-section h3 {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.link-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.link-section li {
    padding: 0.25rem 0;
}

.link-section a {
    color: var(--accent);
    text-decoration: none;
}

.link-section a:hover {
    text-decoration: underline;
}

.link-section.empty {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.graph-link {
    display: block;
    text-align: center;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: 0.5rem;
    color: var(--accent);
    text-decoration: none;
    transition: all 0.2s;
}

.graph-link:hover {
    background: var(--accent);
    color: white;
}

/* ë…¸íŠ¸ ë§í¬ */
.note-link {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px dashed var(--accent);
}

.note-link:hover {
    border-bottom-style: solid;
}

.note-link-missing {
    color: #e17055;
    border-bottom-color: #e17055;
}

/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 768px) {
    .note-layout {
        grid-template-columns: 1fr;
    }
    
    .note-sidebar {
        position: static;
        order: -1;
    }
}

.lang-selector {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
}
</style>

<script>
document.getElementById('extract-cards')?.addEventListener('click', async (e) => {
    const noteId = e.target.dataset.noteId;
    const res = await fetch(`/api/srs/extract/${noteId}`, { method: 'POST' });
    const data = await res.json();
    if (data.extracted > 0) {
        alert(`${data.extracted} {{ t["srs.cards_created"] }}`);
    } else {
        alert('{{ t["srs.no_cards_extracted"] }}');
    }
});
</script>
{% endblock %}
