{% extends "base.html" %}
{% block nav_notes %}{{ t["nav.notes"] }}{% endblock %}
{% block nav_search %}{{ t["nav.search"] }}{% endblock %}
{% block nav_wiki %}{{ t["nav.wiki"] }}{% endblock %}
{% block version %}{{ version }}{% endblock %}
{% block title %}{% if is_new %}{{ t["home.new_note"] }}{% else %}{{ t["editor.edit_note"] }}{% endif %} - Lazarus{% endblock %}
{% block content %}
<div class="editor-container">
<form id="note-form" method="post" action="{% if is_new %}/api/notes{% else %}/api/notes/{{ note_id }}{% endif %}">
        <div class="editor-header">
            <input type="text" id="title" name="title" class="title-input" value="{{ note_title }}" placeholder="{{ t["editor.title_placeholder"] }}" required>
            <div class="editor-actions">
            	<button type="button" class="btn btn-secondary" id="encrypt-btn" title="{{ t["editor.encrypt"] }}">ğŸ”“</button>
                <button type="button" class="btn btn-secondary" id="focus-mode-btn">ğŸ¯ {{ t["editor.focus"] }}</button>
                <button type="button" class="btn btn-secondary" id="fullscreen-btn">â›¶ {{ t["editor.fullscreen"] }}</button>
                <button type="submit" class="btn btn-primary" id="save-btn">ğŸ’¾ {{ t["editor.save"] }}</button>
            </div>
        </div>
        <div class="editor-body">
            <div id="editorjs" class="editorjs-container"></div>
            <input type="hidden" name="content" id="content-input">
            <input type="hidden" name="encrypted" id="encrypted-input" value="false">
        </div>
        
        <div class="editor-footer">
            <div class="form-group tags-group">
                <label for="tags">{{ t["editor.tags"] }}</label>
                <input type="text" name="tags" id="tags" value="{{ tags }}" 
                       placeholder="{{ t["editor.tags_placeholder"] }}" list="tag-suggestions">
                <datalist id="tag-suggestions">
                    {% for tag in all_tags %}
                    <option value="{{ tag }}">
                    {% endfor %}
                </datalist>
            </div>
            <div class="editor-status">
                <span id="auto-save-status">âœ“ {{ t["editor.saved"] }}</span>
                <span id="word-count">0 {{ t["editor.words"] }}</span>
            </div>
        </div>
    </form>
</div>

<style>
.editor-container {
    max-width: 100%;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 120px);
}

.editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border);
}

.title-input {
    flex: 1;
    font-size: 1.75rem;
    font-weight: 700;
    border: none;
    background: transparent;
    color: var(--text);
    padding: 0.5rem;
}

.title-input:focus {
    outline: none;
    border-bottom: 2px solid var(--accent);
}

.editor-actions {
    display: flex;
    gap: 0.5rem;
}

.editor-body {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 0;
}

.editorjs-container {
    min-height: 400px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 1rem;
}

.editor-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-top: 1px solid var(--border);
}

.tags-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.tags-group label {
    margin: 0;
    font-weight: normal;
}

.tags-group input {
    width: 300px;
}

.editor-status {
    display: flex;
    gap: 1rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

#auto-save-status {
    color: var(--success);
}

/* ì§‘ì¤‘ ëª¨ë“œ */
body.focus-mode header,
body.focus-mode footer,
body.focus-mode .editor-footer {
    display: none;
}

body.focus-mode .editor-container {
    height: 100vh;
    max-width: 800px;
}

body.focus-mode .editor-header {
    border: none;
}

body.focus-mode .editor-actions button:not(#save-btn):not(#focus-mode-btn) {
    display: none;
}

/* ì „ì²´í™”ë©´ ëª¨ë“œ */
body.fullscreen-mode {
    overflow: hidden;
}

body.fullscreen-mode header,
body.fullscreen-mode footer {
    display: none;
}

body.fullscreen-mode main {
    max-width: 100%;
    padding: 0 2rem;
}

body.fullscreen-mode .editor-container {
    height: 100vh;
}

/* Editor.js ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
.ce-block__content {
    max-width: 100%;
}

.ce-toolbar__content {
    max-width: 100%;
}

.codex-editor__redactor {
    padding-bottom: 100px !important;
}

.ce-paragraph {
    line-height: 1.8;
}
</style>

<!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
<div id="toast" class="toast"></div>

<!-- ìµœê·¼ ë…¸íŠ¸ ëª¨ë‹¬ -->
<div id="recent-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“‚ ìµœê·¼ ë…¸íŠ¸ ì—´ê¸°</h3>
            <button class="modal-close" id="close-modal">&times;</button>
        </div>
        <ul class="recent-list" id="recent-list">
            {% for tag in all_tags %}
            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            {% endfor %}
        </ul>
    </div>
</div>
<style>
/* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
.toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    padding: 1rem 1.5rem;
    background: var(--accent);
    color: white;
    border-radius: var(--radius);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s;
    z-index: 1000;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

.toast.error {
    background: #dc2626;
}

.toast.success {
    background: #16a34a;
}

/* ëª¨ë‹¬ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--bg);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
}

.recent-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 400px;
    overflow-y: auto;
}

.recent-list li {
    border-bottom: 1px solid var(--border);
}

.recent-list a {
    display: block;
    padding: 1rem;
    color: var(--text);
    text-decoration: none;
}

.recent-list a:hover {
    background: var(--bg-secondary);
}

.recent-list .note-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.recent-list .note-date {
    font-size: 0.875rem;
    color: var(--text-secondary);
}
</style>

<script type="module">
import EditorJS from '/static/editorjs.js';
import Header from '/static/editorjs-header.js';
import NestedList from '/static/editorjs-list.js';
import Quote from '/static/editorjs-quote.js';
import Marker from '/static/editorjs-marker.js';
import InlineCode from '/static/editorjs-inline-code.js';

// ìƒíƒœ ê´€ë¦¬
let isDirty = false;
let isNewNote = {{ is_new }};
let lastSavedContent = '';

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + type + ' show';
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// ê¸°ì¡´ ì½˜í…ì¸  íŒŒì‹±
let initialData = null;
const existingContent = `{{ content }}`;
lastSavedContent = existingContent;

if (existingContent && existingContent.trim()) {
    const paragraphs = existingContent.split('\n').filter(p => p.trim());
    initialData = {
        blocks: paragraphs.map(text => ({
            type: 'paragraph',
            data: { text: text }
        }))
    };
}

// Editor.js ì´ˆê¸°í™”
const editor = new EditorJS({
    holder: 'editorjs',
    placeholder: '{{ t["editor.content_placeholder"] }}',
    data: initialData,
    tools: {
        header: {
            class: Header,
            config: {
                levels: [1, 2, 3, 4],
                defaultLevel: 2
            }
        },
        list: {
            class: NestedList,
            inlineToolbar: true
        },
        quote: {
            class: Quote,
            inlineToolbar: true
        },
        marker: Marker,
        inlineCode: InlineCode
    },
    onChange: () => {
        isDirty = true;
        updateWordCount();
        scheduleAutoSave();
    }
});

// ë‹¨ì–´ ìˆ˜ ì¹´ìš´íŠ¸
function updateWordCount() {
    editor.save().then(data => {
        let text = '';
        data.blocks.forEach(block => {
            if (block.data.text) text += block.data.text + ' ';
            if (block.data.items) {
                block.data.items.forEach(item => {
                    text += (typeof item === 'string' ? item : item.content) + ' ';
                });
            }
        });
        const words = text.trim().split(/\s+/).filter(w => w).length;
        document.getElementById('word-count').textContent = `${words} ë‹¨ì–´`;
    });
}

// ìë™ ì €ì¥
let autoSaveTimer = null;
function scheduleAutoSave() {
    document.getElementById('auto-save-status').textContent = 'â³ ë³€ê²½ë¨...';
    document.getElementById('auto-save-status').style.color = 'var(--text-secondary)';
    
    if (autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(autoSave, 2000);
}

async function autoSave() {
    const data = await editor.save();
    const content = blocksToText(data.blocks);
    document.getElementById('content-input').value = content;
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë°±ì—…
    localStorage.setItem('lazarus-draft', JSON.stringify({
        title: document.getElementById('title').value,
        content: content,
        tags: document.getElementById('tags').value,
        time: Date.now()
    }));
    
    lastSavedContent = content;
    isDirty = false;
    document.getElementById('auto-save-status').textContent = 'âœ“ ìë™ ì €ì¥ë¨';
    document.getElementById('auto-save-status').style.color = 'var(--success)';
}

// Editor.js ë¸”ë¡ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
function blocksToText(blocks) {
    return blocks.map(block => {
        switch (block.type) {
            case 'header':
                return '#'.repeat(block.data.level) + ' ' + block.data.text;
            case 'paragraph':
                return block.data.text;
            case 'list':
                return block.data.items.map((item, i) => {
                    const content = typeof item === 'string' ? item : item.content;
                    return block.data.style === 'ordered' ? `${i+1}. ${content}` : `- ${content}`;
                }).join('\n');
            case 'quote':
                return '> ' + block.data.text;
            default:
                return block.data.text || '';
        }
    }).join('\n\n');
}

// í¼ ì œì¶œ (ì €ì¥)
document.getElementById('note-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = await editor.save();
    const content = blocksToText(data.blocks);
	document.getElementById('content-input').value = content;
    
    // ë“œë˜í”„íŠ¸ ì‚­ì œ
    localStorage.removeItem('lazarus-draft');
    isDirty = false;
    isNewNote = false;
    lastSavedContent = content;
    
    showToast('ğŸ’¾ ì €ì¥ ì™„ë£Œ!', 'success');
    
    // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ì œì¶œ
    setTimeout(() => {
        e.target.submit();
    }, 500);
});
// ì§‘ì¤‘ ëª¨ë“œ í† ê¸€
document.getElementById('focus-mode-btn').addEventListener('click', () => {
    document.body.classList.toggle('focus-mode');
    const btn = document.getElementById('focus-mode-btn');
    const isFocus = document.body.classList.contains('focus-mode');
    btn.textContent = isFocus ? 'âœ• ë‚˜ê°€ê¸°' : 'ğŸ¯ ì§‘ì¤‘';
    showToast(isFocus ? 'ì§‘ì¤‘ ëª¨ë“œ ì¼œì§' : 'ì§‘ì¤‘ ëª¨ë“œ êº¼ì§');
});

// ì „ì²´í™”ë©´ í† ê¸€
document.getElementById('fullscreen-btn').addEventListener('click', () => {
    document.body.classList.toggle('fullscreen-mode');
    const btn = document.getElementById('fullscreen-btn');
    const isFull = document.body.classList.contains('fullscreen-mode');
    btn.textContent = isFull ? 'â›¶ ì¶•ì†Œ' : 'â›¶ ì „ì²´í™”ë©´';
});

// ìµœê·¼ ë…¸íŠ¸ ëª¨ë‹¬
const modal = document.getElementById('recent-modal');
const closeModal = document.getElementById('close-modal');

async function loadRecentNotes() {
    try {
        const response = await fetch('/api/notes');
        const notes = await response.json();
        const list = document.getElementById('recent-list');
        list.innerHTML = notes.slice(0, 10).map(note => `
            <li>
                <a href="/notes/${note.id}/edit">
                    <div class="note-title">${note_title || 'ì œëª© ì—†ìŒ'}</div>
                    <div class="note-date">${note.updated_at}</div>
                </a>
            </li>
        `).join('');
    } catch (e) {
        console.error('ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
}

function openRecentModal() {
    loadRecentNotes();
    modal.classList.add('show');
}

closeModal?.addEventListener('click', () => {
    modal.classList.remove('show');
});

modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
        modal.classList.remove('show');
    }
});

// ë‹¨ì¶•í‚¤
document.addEventListener('keydown', (e) => {
    // Ctrl+S: ì €ì¥
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('note-form').dispatchEvent(new Event('submit'));
    }
    // Ctrl+O: ìµœê·¼ ë…¸íŠ¸ ì—´ê¸°
    if (e.ctrlKey && e.key === 'o') {
        e.preventDefault();
        openRecentModal();
    }
    // Escape: ëª¨ë“œ í•´ì œ ë˜ëŠ” ëª¨ë‹¬ ë‹«ê¸°
    if (e.key === 'Escape') {
        if (modal.classList.contains('show')) {
            modal.classList.remove('show');
        } else {
            document.body.classList.remove('focus-mode');
            document.body.classList.remove('fullscreen-mode');
        }
    }
});

window.addEventListener('beforeunload', (e) => {
    // ì €ì¥ ì™„ë£Œ í›„ì—ëŠ” ê²½ê³  ì•ˆ í•¨
    if (!isDirty) return;
    
    // ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ê²½ê³ 
    e.preventDefault();
    e.returnValue = '';
});

// ë“œë˜í”„íŠ¸ ë³µêµ¬
window.addEventListener('load', () => {
    const draft = localStorage.getItem('lazarus-draft');
    const existingContentCheck = `{{ content }}`;
    if (draft && !existingContentCheck) {
        const data = JSON.parse(draft);
        const age = (Date.now() - data.time) / 1000 / 60;
        if (age < 60) {
            if (confirm(`${Math.round(age)}ë¶„ ì „ì˜ ì„ì‹œ ì €ì¥ë³¸ì´ ìˆìŠµë‹ˆë‹¤. ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                document.getElementById('title').value = data.title || '';
                document.getElementById('tags').value = data.tags || '';
                const paragraphs = data.content.split('\n').filter(p => p.trim());
                editor.render({
                    blocks: paragraphs.map(text => ({
                        type: 'paragraph',
                        data: { text: text }
                    }))
                });
                showToast('ğŸ“„ ì„ì‹œ ì €ì¥ë³¸ ë³µêµ¬ë¨', 'success');
            }
        }
    }
    updateWordCount();
});

// ì´ˆê¸° ë‹¨ì–´ ìˆ˜
setTimeout(updateWordCount, 1000);

// ì•”í˜¸í™” í† ê¸€
let isEncrypted = false;
const encryptBtn = document.getElementById('encrypt-btn');

encryptBtn.addEventListener('click', async () => {
    // PIN ìƒíƒœ í™•ì¸
    const statusRes = await fetch('/api/security/status');
    const status = await statusRes.json();
    
    if (!status.enabled) {
        showToast('ë¨¼ì € PINì„ ì„¤ì •í•˜ì„¸ìš” (ë³´ì•ˆ ë©”ë‰´)', 'error');
        return;
    }
    
    if (status.locked) {
        showToast('PIN ì ê¸ˆì„ í•´ì œí•˜ì„¸ìš”', 'error');
        return;
    }
    
    isEncrypted = !isEncrypted;
    document.getElementById('encrypted-input').value = isEncrypted;
    encryptBtn.textContent = isEncrypted ? 'ğŸ”’' : 'ğŸ”“';
    encryptBtn.title = isEncrypted ? 'ì•”í˜¸í™”ë¨ (í´ë¦­í•˜ì—¬ í•´ì œ)' : 'ì•”í˜¸í™” ì•ˆë¨ (í´ë¦­í•˜ì—¬ ì•”í˜¸í™”)';
    showToast(isEncrypted ? 'ğŸ”’ ì•”í˜¸í™” í™œì„±í™”' : 'ğŸ”“ ì•”í˜¸í™” í•´ì œ', 'success');
    isDirty = true;
});

</script>
{% endblock %}
